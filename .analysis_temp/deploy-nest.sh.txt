FILE: deploy-nest.sh
LINES: 169
============================================================

#!/bin/bash
#
# ðŸ  COZY NEST DEPLOYMENT SCRIPT
# Deploy the entire secure infrastructure step-by-step
#
# Usage: ./deploy-nest.sh
#
# This script will:
# 1. Create the BambiSleep security container
# 2. Setup network monitoring
# 3. Deploy probe launcher
# 4. Configure flare system
# 5. Setup file dropbox
# 6. Install the augment
#

set -e  # Exit on any error

# Colors for output (big friendly letters)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
CONTAINER_ID=100
CONTAINER_NAME="bambisleep-nest"
TEMPLATE="local:vztmpl/alpine-3.19-default_20240207_amd64.tar.xz"
STORAGE="local-lvm"
MEMORY=2048
SWAP=512
CORES=2
DISK_SIZE=8
ROOT_PASSWORD="ChangeMe123!"  # âš ï¸ CHANGE THIS!

echo ""
echo "=========================================="
echo "   ðŸ  COZY NEST DEPLOYMENT"
echo "=========================================="
echo ""

# Step 1: Check if Proxmox is available
echo -e "${BLUE}ðŸ“‹ STEP 1: Checking prerequisites...${NC}"
if ! command -v pct &> /dev/null; then
    echo -e "${RED}âŒ ERROR: This script must run on a Proxmox VE host!${NC}"
    echo "   Please run this script on your Proxmox server."
    exit 1
fi
echo -e "${GREEN}âœ… Proxmox VE detected${NC}"
echo ""

# Step 2: Download Alpine Linux template if needed
echo -e "${BLUE}ðŸ“‹ STEP 2: Checking Alpine Linux template...${NC}"
if ! pveam list local | grep -q "alpine-3.19"; then
    echo "   Downloading Alpine Linux template (this may take a moment)..."
    pveam update
    pveam download local alpine-3.19-default_20240207_amd64.tar.xz
else
    echo -e "${GREEN}âœ… Alpine Linux template found${NC}"
fi
echo ""

# Step 3: Create the BambiSleep container
echo -e "${BLUE}ðŸ“‹ STEP 3: Creating BambiSleep security container...${NC}"
if pct status $CONTAINER_ID &> /dev/null; then
    echo -e "${YELLOW}âš ï¸  Container $CONTAINER_ID already exists${NC}"
    read -p "   Do you want to destroy it and recreate? (yes/no): " -r
    if [[ $REPLY =~ ^[Yy][Ee][Ss]$ ]]; then
        echo "   Stopping and removing existing container..."
        pct stop $CONTAINER_ID 2>/dev/null || true
        pct destroy $CONTAINER_ID
    else
        echo "   Skipping container creation..."
        CONTAINER_ID=$((CONTAINER_ID + 1))
    fi
fi

echo "   Creating unprivileged Alpine Linux container..."
pct create $CONTAINER_ID $TEMPLATE \
    --hostname $CONTAINER_NAME \
    --memory $MEMORY \
    --swap $SWAP \
    --cores $CORES \
    --rootfs $STORAGE:$DISK_SIZE \
    --unprivileged 1 \
    --features nesting=1 \
    --net0 name=eth0,bridge=vmbr0,firewall=1,ip=dhcp \
    --password "$ROOT_PASSWORD" \
    --onboot 1

echo -e "${GREEN}âœ… Container created (ID: $CONTAINER_ID)${NC}"
echo ""

# Step 4: Start the container
echo -e "${BLUE}ðŸ“‹ STEP 4: Starting container...${NC}"
pct start $CONTAINER_ID
sleep 5  # Give it time to boot
echo -e "${GREEN}âœ… Container started${NC}"
echo ""